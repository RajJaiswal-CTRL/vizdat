<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Onboarding Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: #0a0e27;
            color: #e4e4e7;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1900px;
            margin: 0 auto;
        }

        header {
            background: linear-gradient(135deg, #1a1f3a 0%, #2a1f3d 100%);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            margin-bottom: 30px;
            border: 1px solid rgba(255,255,255,0.1);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(139,92,246,0.1) 0%, transparent 70%);
            animation: pulse 8s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        h1 {
            color: #a78bfa;
            font-size: 2.8em;
            margin-bottom: 10px;
            font-weight: 800;
            position: relative;
            z-index: 1;
            text-shadow: 0 0 30px rgba(167,139,250,0.5);
        }

        .subtitle {
            color: #9ca3af;
            font-size: 1.2em;
            position: relative;
            z-index: 1;
        }

        /* Upload Section */
        .upload-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .upload-card {
            background: linear-gradient(135deg, rgba(139,92,246,0.1) 0%, rgba(99,102,241,0.1) 100%);
            border: 2px solid rgba(139,92,246,0.3);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-card:hover {
            border-color: #a78bfa;
            background: linear-gradient(135deg, rgba(139,92,246,0.15) 0%, rgba(99,102,241,0.15) 100%);
            transform: translateY(-5px);
        }

        .upload-card.dragover {
            border-color: #8b5cf6;
            background: rgba(139,92,246,0.2);
        }

        .upload-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .upload-title {
            font-size: 1.3em;
            color: #d1d5db;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .upload-description {
            color: #9ca3af;
            font-size: 0.95em;
        }

        /* Toolbar */
        .toolbar {
            background: rgba(26,31,58,0.8);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.05);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Outfit', sans-serif;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(139,92,246,0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139,92,246,0.6);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: #e4e4e7;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.15);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .file-info {
            background: rgba(99,102,241,0.1);
            border: 1px solid rgba(99,102,241,0.3);
            padding: 15px 20px;
            border-radius: 10px;
            margin-right: auto;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* KPI Cards */
        .kpi-section {
            margin-bottom: 30px;
        }

        .section-title {
            color: #a78bfa;
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: linear-gradient(135deg, rgba(139,92,246,0.1) 0%, rgba(99,102,241,0.1) 100%);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid rgba(139,92,246,0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, #8b5cf6, #6366f1);
        }

        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(139,92,246,0.3);
            border-color: rgba(139,92,246,0.5);
        }

        .kpi-card.positive::before {
            background: linear-gradient(90deg, #10b981, #059669);
        }

        .kpi-card.negative::before {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }

        .kpi-card.warning::before {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }

        .kpi-value {
            font-size: 2.5em;
            font-weight: 700;
            background: linear-gradient(135deg, #a78bfa 0%, #818cf8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .kpi-label {
            color: #9ca3af;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .kpi-change {
            margin-top: 10px;
            font-size: 0.85em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .kpi-change.positive { color: #6ee7b7; }
        .kpi-change.negative { color: #fca5a5; }
        .kpi-change.neutral { color: #fcd34d; }

        /* Charts */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: rgba(26,31,58,0.6);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
        }

        .chart-card.large {
            grid-column: 1 / -1;
        }

        .chart-title {
            font-size: 1.3em;
            color: #e4e4e7;
            margin-bottom: 20px;
            font-weight: 600;
        }

        /* Client Cards */
        .clients-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .client-card {
            background: rgba(26,31,58,0.6);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            cursor: pointer;
            border-left: 4px solid #cbd5e0;
        }

        .client-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(139,92,246,0.3);
            border-left-color: #8b5cf6;
        }

        .client-card.status-complete { border-left-color: #10b981; }
        .client-card.status-at-risk { border-left-color: #ef4444; }
        .client-card.status-in-progress { border-left-color: #3b82f6; }
        .client-card.status-training { border-left-color: #8b5cf6; }
        .client-card.status-testing { border-left-color: #f59e0b; }

        .client-name {
            font-size: 1.3em;
            font-weight: 700;
            color: #e4e4e7;
            margin-bottom: 10px;
        }

        .client-meta {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 15px;
            font-size: 0.85em;
            color: #9ca3af;
        }

        .progress-bar-container {
            background: rgba(255,255,255,0.05);
            height: 8px;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #8b5cf6, #6366f1);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .badge-complete { background: rgba(16,185,129,0.2); color: #6ee7b7; border: 1px solid rgba(16,185,129,0.4); }
        .badge-in-progress { background: rgba(59,130,246,0.2); color: #93c5fd; border: 1px solid rgba(59,130,246,0.4); }
        .badge-training { background: rgba(139,92,246,0.2); color: #c4b5fd; border: 1px solid rgba(139,92,246,0.4); }
        .badge-testing { background: rgba(245,158,11,0.2); color: #fcd34d; border: 1px solid rgba(245,158,11,0.4); }
        .badge-at-risk { background: rgba(239,68,68,0.2); color: #fca5a5; border: 1px solid rgba(239,68,68,0.4); }
        .badge-not-started { background: rgba(107,114,128,0.2); color: #d1d5db; border: 1px solid rgba(107,114,128,0.4); }

        .risk-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: 700;
            text-transform: uppercase;
        }

        .risk-low { background: rgba(16,185,129,0.2); color: #6ee7b7; }
        .risk-medium { background: rgba(245,158,11,0.2); color: #fcd34d; }
        .risk-high { background: rgba(239,68,68,0.2); color: #fca5a5; }
        .risk-critical { background: rgba(239,68,68,0.8); color: white; }

        /* Filters */
        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 10px 20px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: #9ca3af;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-family: 'Outfit', sans-serif;
        }

        .filter-btn:hover {
            border-color: #8b5cf6;
            color: #c4b5fd;
            background: rgba(139,92,246,0.1);
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
            border-color: transparent;
        }

        /* Table */
        .table-container {
            background: rgba(26,31,58,0.6);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            margin-bottom: 30px;
        }

        .search-box {
            margin-bottom: 20px;
            padding: 15px 20px;
            width: 100%;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(167,139,250,0.3);
            border-radius: 10px;
            font-size: 1em;
            color: #e4e4e7;
            font-family: 'Outfit', sans-serif;
            transition: all 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: #8b5cf6;
            background: rgba(255,255,255,0.08);
            box-shadow: 0 0 20px rgba(139,92,246,0.3);
        }

        .search-box::placeholder {
            color: #6b7280;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        th {
            background: linear-gradient(135deg, rgba(139,92,246,0.3) 0%, rgba(99,102,241,0.3) 100%);
            color: #e4e4e7;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 2px solid rgba(139,92,246,0.5);
        }

        td {
            padding: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            color: #d1d5db;
            font-size: 0.9em;
        }

        tr:hover {
            background: rgba(139,92,246,0.1);
        }

        .scroll-container {
            max-height: 500px;
            overflow-y: auto;
        }

        .scroll-container::-webkit-scrollbar {
            width: 10px;
        }

        .scroll-container::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 5px;
        }

        .scroll-container::-webkit-scrollbar-thumb {
            background: rgba(139,92,246,0.5);
            border-radius: 5px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: linear-gradient(135deg, #1a1f3a 0%, #2a1f3d 100%);
            padding: 40px;
            border-radius: 20px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .modal-header {
            font-size: 1.8em;
            margin-bottom: 10px;
            color: #a78bfa;
            font-weight: 700;
        }

        .modal-subheader {
            color: #9ca3af;
            margin-bottom: 25px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .detail-item {
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .detail-label {
            font-size: 0.8em;
            color: #9ca3af;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 1.1em;
            color: #e4e4e7;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #9ca3af;
            font-weight: 600;
            font-size: 0.9em;
        }

        input[type="text"], input[type="url"], select {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(167,139,250,0.4);
            color: #e4e4e7;
            padding: 12px 16px;
            border-radius: 8px;
            font-family: 'Outfit', sans-serif;
            width: 100%;
            font-size: 1em;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #8b5cf6;
            box-shadow: 0 0 10px rgba(139,92,246,0.3);
        }

        input[type="file"] { display: none; }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 2000;
            animation: slideIn 0.3s ease;
            display: none;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .notification.error { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .notification.info { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }

        .hidden { display: none !important; }

        .help-text {
            color: #9ca3af;
            font-size: 0.85em;
            margin-top: 5px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #8b5cf6, #6366f1);
            transition: width 0.3s ease;
        }

        @media (max-width: 768px) {
            .charts-grid { grid-template-columns: 1fr; }
            .clients-grid { grid-template-columns: 1fr; }
            .detail-grid { grid-template-columns: 1fr; }
            h1 { font-size: 2em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöÄ Client Onboarding Dashboard</h1>
            <p class="subtitle">Track, manage, and optimize your client onboarding journey</p>
        </header>

        <div id="uploadSection">
            <div class="upload-options">
                <div class="upload-card" id="fileUploadCard">
                    <div class="upload-icon">üì§</div>
                    <div class="upload-title">Upload CSV/Excel</div>
                    <div class="upload-description">Drag & drop or click to browse</div>
                    <input type="file" id="fileInput" accept=".csv,.xlsx,.xls">
                </div>
                
                <div class="upload-card" onclick="openGoogleSheetsModal()">
                    <div class="upload-icon">üìä</div>
                    <div class="upload-title">Connect Google Sheets</div>
                    <div class="upload-description">Live data with auto-refresh</div>
                </div>

                <div class="upload-card" onclick="loadSampleData()">
                    <div class="upload-icon">üéØ</div>
                    <div class="upload-title">Use Sample Data</div>
                    <div class="upload-description">Try with demo onboarding data</div>
                </div>
            </div>
        </div>

        <div id="dashboardSection" class="hidden">
            <div class="toolbar">
                <div class="file-info" id="fileInfo">
                    <span>üìÑ</span>
                    <span id="fileName">No file loaded</span>
                </div>
                <button class="btn btn-primary" onclick="uploadNew()">üì§ Upload New</button>
                <button class="btn btn-success" onclick="exportData()">üì• Export CSV</button>
                <button class="btn btn-secondary" onclick="refreshData()">üîÑ Refresh</button>
                <button class="btn btn-danger" onclick="clearData()">üóëÔ∏è Clear</button>
            </div>

            <!-- KPIs -->
            <div class="kpi-section">
                <h2 class="section-title">üìä Key Performance Indicators</h2>
                <div class="kpi-grid" id="kpiGrid"></div>
            </div>

            <!-- Charts -->
            <div class="kpi-section">
                <h2 class="section-title">üìà Analytics Overview</h2>
                <div class="charts-grid" id="chartsGrid"></div>
            </div>

            <!-- Client Cards -->
            <div class="kpi-section">
                <h2 class="section-title">üë• Active Onboardings</h2>
                <div class="filters">
                    <button class="filter-btn active" onclick="filterClients('all')">All Clients</button>
                    <button class="filter-btn" onclick="filterClients('In Progress')">In Progress</button>
                    <button class="filter-btn" onclick="filterClients('At Risk')">At Risk</button>
                    <button class="filter-btn" onclick="filterClients('Training')">Training</button>
                    <button class="filter-btn" onclick="filterClients('Testing')">Testing</button>
                    <button class="filter-btn" onclick="filterClients('Complete')">Complete</button>
                </div>
                <div class="clients-grid" id="clientsGrid"></div>
            </div>

            <!-- Table -->
            <div class="table-container">
                <h3 class="chart-title">üìã Detailed Onboarding Data</h3>
                <input type="text" id="searchBox" class="search-box" placeholder="üîç Search clients, owners, or status...">
                <div class="scroll-container">
                    <table>
                        <thead id="tableHead"></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Google Sheets Modal -->
    <div id="googleSheetsModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-header">Connect Google Sheets</h2>
            <div class="form-group">
                <label>Google Sheets URL</label>
                <input type="url" id="sheetsUrl" placeholder="https://docs.google.com/spreadsheets/d/...">
                <div class="help-text">
                    <strong>Setup Instructions:</strong><br>
                    1. Open your Google Sheet<br>
                    2. Click "File" ‚Üí "Share" ‚Üí "Publish to web"<br>
                    3. Choose "Comma-separated values (.csv)" format<br>
                    4. Click "Publish" and copy the link<br>
                    5. Paste the link above
                </div>
            </div>
            <div class="form-group">
                <label>Auto-refresh Interval (minutes)</label>
                <select id="refreshInterval">
                    <option value="0">Manual only</option>
                    <option value="1">Every 1 minute</option>
                    <option value="5" selected>Every 5 minutes</option>
                    <option value="10">Every 10 minutes</option>
                    <option value="30">Every 30 minutes</option>
                </select>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 30px;">
                <button class="btn btn-primary" style="flex: 1;" onclick="connectGoogleSheets()">Connect</button>
                <button class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Client Detail Modal -->
    <div id="clientModal" class="modal">
        <div class="modal-content">
            <div id="modalContent"></div>
            <button class="btn btn-secondary" onclick="closeClientModal()" style="margin-top: 30px; width: 100%;">Close</button>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loadingModal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <h2 class="modal-header">Processing Data...</h2>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <p id="loadingText" style="color: #9ca3af; margin-top: 15px;">Loading...</p>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let rawData = [];
        let filteredData = [];
        let columns = [];
        let charts = {};
        let currentFilter = 'all';
        let currentFileName = '';
        let refreshIntervalId = null;
        let isGoogleSheets = false;
        let sheetsUrl = '';

        // File upload handling
        const fileUploadCard = document.getElementById('fileUploadCard');
        const fileInput = document.getElementById('fileInput');

        fileUploadCard.addEventListener('click', () => fileInput.click());
        fileUploadCard.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadCard.classList.add('dragover');
        });
        fileUploadCard.addEventListener('dragleave', () => {
            fileUploadCard.classList.remove('dragover');
        });
        fileUploadCard.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadCard.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleFile(e.target.files[0]);
        });

        function showLoading(message = 'Processing...') {
            document.getElementById('loadingModal').classList.add('active');
            document.getElementById('loadingText').textContent = message;
            document.getElementById('progressFill').style.width = '0%';
        }

        function updateProgress(percent, message) {
            document.getElementById('progressFill').style.width = percent + '%';
            if (message) document.getElementById('loadingText').textContent = message;
        }

        function hideLoading() {
            document.getElementById('loadingModal').classList.remove('active');
        }

        async function handleFile(file) {
            currentFileName = file.name;
            isGoogleSheets = false;
            showLoading('Loading file...');
            updateProgress(20, 'Reading file...');
            
            const reader = new FileReader();
            
            if (file.name.endsWith('.csv')) {
                reader.onload = async (e) => {
                    updateProgress(50, 'Parsing CSV...');
                    await new Promise(resolve => setTimeout(resolve, 100));
                    await parseCSV(e.target.result);
                    updateProgress(100, 'Complete!');
                    setTimeout(hideLoading, 500);
                };
                reader.readAsText(file);
            } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                reader.onload = async (e) => {
                    updateProgress(50, 'Parsing Excel...');
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const csv = XLSX.utils.sheet_to_csv(workbook.Sheets[workbook.SheetNames[0]]);
                    await parseCSV(csv);
                    updateProgress(100, 'Complete!');
                    setTimeout(hideLoading, 500);
                };
                reader.readAsArrayBuffer(file);
            }
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        async function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            if (lines.length < 2) {
                hideLoading();
                showNotification('File must have headers and data', 'error');
                return;
            }

            columns = parseCSVLine(lines[0]);
            rawData = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = parseCSVLine(lines[i]);
                    const record = {};
                    columns.forEach((col, index) => {
                        record[col] = values[index] || '';
                    });
                    rawData.push(record);
                }
            }

            saveToStorage();
            await initializeDashboard();
            showNotification(`Loaded ${rawData.length} onboarding records`, 'success');
        }

        function loadSampleData() {
            const sampleCSV = `Client Name,Status,Onboarding Owner,Start Date,Expected Completion,Actual Completion,Days Active,Progress %,Current Phase,Priority,Deal Value,Account Type,Industry,Company Size,Primary Contact,Contact Email,Risk Level,Health Score,Blockers,Next Steps,Notes
Acme Corporation,In Progress,Sarah Johnson,2024-01-15,2024-03-15,,-31,65,Technical Setup,High,125000,Enterprise,Technology,500-1000,John Smith,john.smith@acme.com,Medium,75,API rate limiting issues,Complete data migration by Feb 15,Working on custom integrations
TechStart Inc,Training,Michael Davis,2024-01-22,2024-03-22,,-12,80,User Training,High,85000,Mid-Market,Software,100-500,Emily Chen,emily.chen@techstart.com,Low,85,None,Schedule UAT sessions,Great progress - team engaged
Global Solutions,Testing,Jennifer Lee,2024-01-08,2024-02-28,,-27,90,UAT Testing,Medium,95000,Enterprise,Finance,1000+,David Park,david.park@globalsol.com,Low,90,Minor bugs in reporting,Fix bugs and schedule go-live,Ready for production launch
Innovation Labs,Complete,Alex Rodriguez,2023-12-01,2024-02-01,2024-01-28,89,100,Live,Low,65000,SMB,Marketing,50-100,Rachel Green,rachel@innovlabs.com,Low,95,None,Monitor usage,Excellent onboarding
Future Systems,Not Started,Sarah Johnson,2024-02-05,2024-04-05,,-0,0,Pending Kickoff,Medium,70000,Mid-Market,Healthcare,250-500,Dr. Wilson,j.wilson@futuresys.com,High,20,Contract signature pending,Get contract signed,Awaiting legal approval
Digital Wave,In Progress,Michael Davis,2024-01-18,2024-03-18,,-17,55,Data Migration,High,105000,Enterprise,Retail,500-1000,Maria Garcia,maria@digitalwave.com,Medium,70,Data quality issues,Clean data and complete migration,Data taking longer than expected
Smart Tech,Training,Jennifer Lee,2024-01-25,2024-03-25,,-10,75,User Training,Medium,88000,Mid-Market,Education,100-250,Prof. Turner,a.turner@smarttech.edu,Low,80,None,Complete admin training,Academic calendar delays
Cloud Nine,At Risk,Alex Rodriguez,2024-01-10,2024-03-10,,-25,40,Technical Setup,Critical,115000,Enterprise,Manufacturing,1000+,Robert Chen,r.chen@cloudnine.com,High,45,Technical resource unavailable,Escalate to engineering,Customer frustrated
Data Dynamics,In Progress,Sarah Johnson,2024-02-01,2024-04-01,,-4,30,Kickoff Complete,Medium,92000,Mid-Market,Analytics,250-500,Laura Martinez,laura@datadynamics.com,Medium,65,Waiting for IT approval,Follow up with IT department,Internal processes slow
Next Gen,Training,Michael Davis,2024-01-20,2024-03-20,,-15,70,User Training,High,78000,SMB,Consulting,50-100,Sophie Anderson,sophie@nextgen.co,Low,75,None,Complete end-user training,Small engaged team
Bright Future,Complete,Jennifer Lee,2023-12-15,2024-02-15,2024-02-10,87,100,Live,Low,95000,Mid-Market,Non-Profit,100-250,Thomas Wright,t.wright@brightfuture.org,Low,92,None,30-day health check,Smooth onboarding
Tech Innovators,Testing,Alex Rodriguez,2024-01-12,2024-03-12,,-23,85,UAT Testing,Medium,98000,Enterprise,Technology,500-1000,Daniel Kim,d.kim@techinnovators.com,Low,88,Minor UX feedback,Address UX issues,On track for early launch
Vertex Solutions,In Progress,Sarah Johnson,2024-01-28,2024-03-28,,-7,50,Data Migration,High,110000,Enterprise,Legal,250-500,Lisa Brown,l.brown@vertexsol.com,Medium,68,Compliance review required,Complete compliance docs,Legal compliance adding steps
Quantum Corp,Training,Michael Davis,2024-01-16,2024-03-16,,-19,72,User Training,Medium,87000,Mid-Market,Energy,250-500,Chris Anderson,c.anderson@quantum.com,Low,78,None,Finish power user training,Power users driving adoption
Phoenix Industries,At Risk,Jennifer Lee,2024-01-05,2024-03-05,,-30,35,Technical Setup,Critical,125000,Enterprise,Manufacturing,1000+,Michelle Taylor,m.taylor@phoenix.com,Critical,40,Executive sponsor left,Identify new champion,Critical escalation needed`;
            
            parseCSV(sampleCSV);
            currentFileName = 'Sample Onboarding Data';
        }

        async function initializeDashboard() {
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.remove('hidden');
            document.getElementById('fileName').textContent = currentFileName;
            filteredData = [...rawData];
            await refreshDashboard();
        }

        async function refreshDashboard() {
            renderKPIs();
            renderCharts();
            renderClientCards();
            renderTable();
            setupSearch();
        }

        function renderKPIs() {
            const kpis = calculateKPIs();
            const kpiGrid = document.getElementById('kpiGrid');
            
            kpiGrid.innerHTML = `
                <div class="kpi-card">
                    <div class="kpi-value">${kpis.total}</div>
                    <div class="kpi-label">Total Onboardings</div>
                </div>
                <div class="kpi-card positive">
                    <div class="kpi-value">${kpis.active}</div>
                    <div class="kpi-label">Active</div>
                    <div class="kpi-change positive">‚Üó ${kpis.inProgress} in progress</div>
                </div>
                <div class="kpi-card ${kpis.atRiskCount > 0 ? 'negative' : 'positive'}">
                    <div class="kpi-value">${kpis.atRiskCount}</div>
                    <div class="kpi-label">At Risk</div>
                    ${kpis.atRiskValue ? `<div class="kpi-change negative">$${(kpis.atRiskValue/1000).toFixed(0)}K at risk</div>` : ''}
                </div>
                <div class="kpi-card positive">
                    <div class="kpi-value">${kpis.completionRate}%</div>
                    <div class="kpi-label">Completion Rate</div>
                    <div class="kpi-change positive">${kpis.completed} completed</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value">${kpis.avgProgress}%</div>
                    <div class="kpi-label">Avg Progress</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value">${kpis.avgDays}</div>
                    <div class="kpi-label">Avg Days Active</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value">${kpis.healthScore}</div>
                    <div class="kpi-label">Avg Health Score</div>
                    <div class="kpi-change ${kpis.healthScore >= 75 ? 'positive' : 'neutral'}">out of 100</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value">$${(kpis.totalValue/1000).toFixed(0)}K</div>
                    <div class="kpi-label">Total Pipeline Value</div>
                </div>
            `;
        }

        function calculateKPIs() {
            const total = rawData.length;
            const completed = rawData.filter(r => r.Status === 'Complete').length;
            const inProgress = rawData.filter(r => r.Status === 'In Progress').length;
            const atRisk = rawData.filter(r => r.Status === 'At Risk' || r['Risk Level'] === 'High' || r['Risk Level'] === 'Critical');
            
            const progressValues = rawData.map(r => parseFloat(r['Progress %']) || 0).filter(v => v > 0);
            const daysActive = rawData.map(r => Math.abs(parseInt(r['Days Active']) || 0)).filter(v => v > 0);
            const healthScores = rawData.map(r => parseInt(r['Health Score']) || 0).filter(v => v > 0);
            
            const atRiskValue = atRisk.reduce((sum, r) => {
                const val = parseFloat(String(r['Deal Value']).replace(/[^0-9.-]/g, '')) || 0;
                return sum + val;
            }, 0);

            const totalValue = rawData.reduce((sum, r) => {
                const val = parseFloat(String(r['Deal Value']).replace(/[^0-9.-]/g, '')) || 0;
                return sum + val;
            }, 0);
            
            return {
                total,
                active: total - completed,
                completed,
                inProgress,
                atRiskCount: atRisk.length,
                atRiskValue,
                completionRate: total > 0 ? Math.round((completed / total) * 100) : 0,
                avgProgress: progressValues.length > 0 ? Math.round(progressValues.reduce((a,b) => a+b, 0) / progressValues.length) : 0,
                avgDays: daysActive.length > 0 ? Math.round(daysActive.reduce((a,b) => a+b, 0) / daysActive.length) : 0,
                healthScore: healthScores.length > 0 ? Math.round(healthScores.reduce((a,b) => a+b, 0) / healthScores.length) : 0,
                totalValue
            };
        }

        function renderCharts() {
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};
            
            const container = document.getElementById('chartsGrid');
            container.innerHTML = '';
            
            // Status distribution
            const statusCounts = {};
            rawData.forEach(r => {
                const status = r.Status || 'Unknown';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });
            createChart(container, 'Onboarding Status', 'doughnut', statusCounts);
            
            // Current phase
            const phaseCounts = {};
            rawData.forEach(r => {
                const phase = r['Current Phase'] || 'Unknown';
                phaseCounts[phase] = (phaseCounts[phase] || 0) + 1;
            });
            createChart(container, 'Current Phase Distribution', 'bar', phaseCounts);
            
            // Owner workload
            const ownerCounts = {};
            rawData.filter(r => r.Status !== 'Complete').forEach(r => {
                const owner = r['Onboarding Owner'] || 'Unassigned';
                ownerCounts[owner] = (ownerCounts[owner] || 0) + 1;
            });
            createChart(container, 'Active Onboardings by Owner', 'bar', ownerCounts);
            
            // Risk distribution
            const riskCounts = {};
            rawData.forEach(r => {
                const risk = r['Risk Level'] || 'Unknown';
                riskCounts[risk] = (riskCounts[risk] || 0) + 1;
            });
            createChart(container, 'Risk Level Distribution', 'pie', riskCounts);
        }

        function createChart(container, title, type, data) {
            const chartCard = document.createElement('div');
            chartCard.className = 'chart-card';
            const chartId = 'chart_' + Math.random().toString(36).substr(2, 9);
            chartCard.innerHTML = `
                <h3 class="chart-title">${title}</h3>
                <canvas id="${chartId}"></canvas>
            `;
            container.appendChild(chartCard);
            
            const ctx = document.getElementById(chartId);
            const colors = ['#8b5cf6', '#6366f1', '#ec4899', '#14b8a6', '#f59e0b', '#10b981', '#ef4444', '#06b6d4'];
            
            charts[chartId] = new Chart(ctx, {
                type: type,
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: colors,
                        borderWidth: 0,
                        borderRadius: type === 'bar' ? 8 : 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: type === 'doughnut' || type === 'pie' ? 'bottom' : 'top',
                            labels: { color: '#e4e4e7', font: { size: 11 } }
                        }
                    },
                    scales: type === 'bar' ? {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1, color: '#9ca3af' },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        },
                        x: {
                            ticks: { color: '#9ca3af' },
                            grid: { display: false }
                        }
                    } : {}
                }
            });
        }

        function renderClientCards() {
            const grid = document.getElementById('clientsGrid');
            const data = currentFilter === 'all' ? filteredData : filteredData.filter(r => r.Status === currentFilter);
            
            grid.innerHTML = data.map(client => {
                const progress = parseFloat(client['Progress %']) || 0;
                const status = client.Status || 'Unknown';
                const statusClass = status.toLowerCase().replace(/\s+/g, '-');
                
                return `
                    <div class="client-card status-${statusClass}" onclick="showClientDetail('${client['Client Name'].replace(/'/g, "\\'")}')">
                        <div class="client-name">${client['Client Name']}</div>
                        <div class="client-meta">
                            <span>üë§ ${client['Onboarding Owner'] || 'Unassigned'}</span>
                            <span>üìÖ ${Math.abs(parseInt(client['Days Active']) || 0)} days</span>
                            <span>üí∞ $${(parseFloat(String(client['Deal Value']).replace(/[^0-9.-]/g, '')) / 1000).toFixed(0)}K</span>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill" style="width: ${progress}%"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span class="status-badge badge-${statusClass}">${status}</span>
                            <span class="risk-badge risk-${(client['Risk Level'] || 'low').toLowerCase()}">${client['Risk Level'] || 'Low'}</span>
                            <span style="color: #9ca3af; font-weight: 600;">${progress}%</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterClients(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderClientCards();
        }

        function showClientDetail(clientName) {
            const client = rawData.find(r => r['Client Name'] === clientName);
            if (!client) return;
            
            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = `
                <div class="modal-header">${client['Client Name']}</div>
                <div class="modal-subheader">
                    <span class="status-badge badge-${client.Status.toLowerCase().replace(/\s+/g, '-')}">${client.Status}</span>
                    <span class="risk-badge risk-${(client['Risk Level'] || 'low').toLowerCase()}">${client['Risk Level'] || 'Low'} Risk</span>
                </div>
                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">Owner</div>
                        <div class="detail-value">${client['Onboarding Owner']}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Progress</div>
                        <div class="detail-value">${client['Progress %']}%</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Current Phase</div>
                        <div class="detail-value">${client['Current Phase']}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Days Active</div>
                        <div class="detail-value">${Math.abs(parseInt(client['Days Active']) || 0)} days</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Deal Value</div>
                        <div class="detail-value">$${(parseFloat(String(client['Deal Value']).replace(/[^0-9.-]/g, '')) / 1000).toFixed(0)}K</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Health Score</div>
                        <div class="detail-value">${client['Health Score']}/100</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Primary Contact</div>
                        <div class="detail-value">${client['Primary Contact']}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Contact Email</div>
                        <div class="detail-value" style="font-size: 0.9em;">${client['Contact Email']}</div>
                    </div>
                    <div class="detail-item" style="grid-column: 1 / -1;">
                        <div class="detail-label">Blockers</div>
                        <div class="detail-value">${client.Blockers || 'None'}</div>
                    </div>
                    <div class="detail-item" style="grid-column: 1 / -1;">
                        <div class="detail-label">Next Steps</div>
                        <div class="detail-value">${client['Next Steps']}</div>
                    </div>
                    <div class="detail-item" style="grid-column: 1 / -1;">
                        <div class="detail-label">Notes</div>
                        <div class="detail-value">${client.Notes || 'No notes'}</div>
                    </div>
                </div>
            `;
            
            document.getElementById('clientModal').classList.add('active');
        }

        function closeClientModal() {
            document.getElementById('clientModal').classList.remove('active');
        }

        function renderTable() {
            const tableHead = document.getElementById('tableHead');
            const tableBody = document.getElementById('tableBody');
            
            const displayCols = ['Client Name', 'Status', 'Onboarding Owner', 'Progress %', 'Current Phase', 'Days Active', 'Risk Level', 'Health Score'];
            
            tableHead.innerHTML = `<tr>${displayCols.map(col => `<th>${col}</th>`).join('')}</tr>`;
            tableBody.innerHTML = filteredData.map(record => 
                `<tr onclick="showClientDetail('${record['Client Name'].replace(/'/g, "\\'")}')">
                    ${displayCols.map(col => `<td>${record[col] || '-'}</td>`).join('')}
                </tr>`
            ).join('');
        }

        function setupSearch() {
            const searchBox = document.getElementById('searchBox');
            searchBox.oninput = (e) => {
                const term = e.target.value.toLowerCase();
                filteredData = rawData.filter(r => 
                    (r['Client Name'] || '').toLowerCase().includes(term) ||
                    (r['Onboarding Owner'] || '').toLowerCase().includes(term) ||
                    (r.Status || '').toLowerCase().includes(term)
                );
                renderClientCards();
                renderTable();
            };
        }

        function openGoogleSheetsModal() {
            document.getElementById('googleSheetsModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('googleSheetsModal').classList.remove('active');
        }

        async function connectGoogleSheets() {
            const url = document.getElementById('sheetsUrl').value.trim();
            
            if (!url) {
                showNotification('Please enter a Google Sheets URL', 'error');
                return;
            }

            let csvUrl = url;
            if (url.includes('/edit')) {
                csvUrl = url.replace('/edit#gid=', '/export?format=csv&gid=');
                csvUrl = csvUrl.replace('/edit?usp=sharing', '/export?format=csv');
                csvUrl = csvUrl.replace('/edit', '/export?format=csv');
            }

            sheetsUrl = csvUrl;
            isGoogleSheets = true;
            currentFileName = 'Google Sheets';
            
            closeModal();
            await loadGoogleSheets();
            
            const interval = parseInt(document.getElementById('refreshInterval').value);
            if (interval > 0) {
                if (refreshIntervalId) clearInterval(refreshIntervalId);
                refreshIntervalId = setInterval(loadGoogleSheets, interval * 60 * 1000);
                showNotification(`Connected! Auto-refreshing every ${interval} minute(s)`, 'success');
            } else {
                showNotification('Connected to Google Sheets!', 'success');
            }
        }

        async function loadGoogleSheets() {
            showLoading('Loading from Google Sheets...');
            
            try {
                updateProgress(30, 'Fetching data...');
                const response = await fetch(sheetsUrl);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch Google Sheets');
                }
                
                updateProgress(60, 'Parsing data...');
                const csv = await response.text();
                await parseCSV(csv);
                updateProgress(100, 'Complete!');
                setTimeout(hideLoading, 500);
            } catch (error) {
                hideLoading();
                showNotification('Error loading Google Sheets: ' + error.message, 'error');
            }
        }

        function saveToStorage() {
            try {
                localStorage.setItem('onboardingColumns', JSON.stringify(columns));
                localStorage.setItem('onboardingFileName', currentFileName);
                localStorage.setItem('onboardingIsGoogleSheets', isGoogleSheets);
                if (isGoogleSheets) {
                    localStorage.setItem('onboardingSheetsUrl', sheetsUrl);
                }
            } catch (e) {
                console.warn('LocalStorage full');
            }
        }

        function exportData() {
            let csv = columns.map(h => `"${h}"`).join(',') + '\n';
            rawData.forEach(record => {
                csv += columns.map(col => `"${String(record[col] || '').replace(/"/g, '""')}"`).join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'onboarding_export_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
            showNotification('Data exported successfully', 'success');
        }

        function uploadNew() {
            if (confirm('Upload new data?')) {
                clearData();
            }
        }

        async function refreshData() {
            if (isGoogleSheets && sheetsUrl) {
                await loadGoogleSheets();
            } else {
                await refreshDashboard();
                showNotification('Dashboard refreshed', 'info');
            }
        }

        function clearData() {
            if (refreshIntervalId) clearInterval(refreshIntervalId);
            localStorage.clear();
            location.reload();
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            setTimeout(() => notification.style.display = 'none', 3000);
        }

        // Auto-load saved Google Sheets
        window.addEventListener('DOMContentLoaded', async () => {
            const savedColumns = localStorage.getItem('onboardingColumns');
            const savedFileName = localStorage.getItem('onboardingFileName');
            const savedIsGoogleSheets = localStorage.getItem('onboardingIsGoogleSheets') === 'true';
            const savedSheetsUrl = localStorage.getItem('onboardingSheetsUrl');
            
            if (savedColumns && savedFileName && savedIsGoogleSheets && savedSheetsUrl) {
                columns = JSON.parse(savedColumns);
                currentFileName = savedFileName;
                isGoogleSheets = true;
                sheetsUrl = savedSheetsUrl;
                showNotification('Reconnecting to Google Sheets...', 'info');
                await loadGoogleSheets();
            }
        });
    </script>
</body>
</html>
